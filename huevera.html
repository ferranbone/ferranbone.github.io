let canvas_w = 800;
let canvas_h = 450;
let gameOver = false;
let tiempoRestante = 60;
let puntuacion = 0;
let tiempoTexto, puntuacionTexto;
let fondoMusica, gameOverMusica, sonidoAgarre, sonidoCorrecta, sonidoIncorrecta;
let huevos = [];

function crea() {
    this.add.image(canvas_w / 2, canvas_h / 2, 'fondo').setDisplaySize(canvas_w, canvas_h);
    
    tiempoTexto = this.add.text(10, 10, 'Tiempo: ' + tiempoRestante, { fontSize: '20px', fill: '#FFF' });
    puntuacionTexto = this.add.text(10, 40, 'Puntos: ' + puntuacion, { fontSize: '20px', fill: '#FFF' });

    fondoMusica = this.sound.add('musica_fondo', { loop: true, volume: 0.5 });
    gameOverMusica = this.sound.add('musica_gameover', { loop: false, volume: 0.8 });
    sonidoAgarre = this.sound.add('sonido_agarre', { volume: 1 });
    sonidoCorrecta = this.sound.add('sonido_correcto', { volume: 1 });
    sonidoIncorrecta = this.sound.add('sonido_incorrecto', { volume: 1 });

    fondoMusica.play();

    this.time.addEvent({ delay: 1000, callback: actualizarTiempo, callbackScope: this, loop: true });
    this.time.addEvent({ delay: 2000, callback: generarHuevoAleatorio, callbackScope: this, loop: true });
}

function actualizarTiempo() {
    if (gameOver) return;
    tiempoRestante--;
    actualizarHUD();
    if (tiempoRestante <= 0) mostrarGameOver(this);
}

function actualizarHUD() {
    tiempoTexto.setText('Tiempo: ' + tiempoRestante);
    puntuacionTexto.setText('Puntos: ' + puntuacion);
}

function generarHuevoAleatorio() {
    if (gameOver) return;
    
    let scene = this;
    let huevoNuevo = this.add.image(Math.random() * (canvas_w - 50), -50, 'huevo');
    huevoNuevo.setScale(0.5);
    huevoNuevo.setInteractive({ draggable: true });
    
    let velocidad = Math.random() * 2 + 1;
    huevoNuevo.cayendo = this.tweens.add({
        targets: huevoNuevo,
        y: canvas_h + 50,
        duration: velocidad * 3000,
        ease: 'Linear',
        onComplete: function () {
            if (!gameOver) huevoNuevo.destroy();
        }
    });

    huevoNuevo.on('dragstart', function () {
        if (gameOver) return;
        sonidoAgarre.play();
        huevoNuevo.cayendo.pause();
    });

    huevoNuevo.on('dragend', function (pointer) {
        if (gameOver) return;
        let correcto = false;
        
        let hueveras = [
            { object: huevera_b, color: 0xFFFFFF },
            { object: huevera_m, color: 0x8B4513 },
            { object: huevera_d, color: 0xFFD700 }
        ];

        for (let i = 0; i < hueveras.length; i++) {
            let huevera = hueveras[i];
            if (Phaser.Geom.Intersects.RectangleToRectangle(huevera.object.getBounds(), huevoNuevo.getBounds())) {
                if (huevoNuevo.tintTopLeft === huevera.color) {
                    sonidoCorrecta.play();
                    correcto = true;
                    puntuacion += 10;
                    huevoNuevo.destroy();
                }
            }
        }

        if (!correcto) {
            sonidoIncorrecta.play();
            puntuacion -= 5;
        }

        actualizarHUD();
    });

    huevos.push(huevoNuevo);
}

function mostrarGameOver(scene) {
    gameOver = true;
    fondoMusica.stop();
    gameOverMusica.play();
    
    huevos.forEach(h => {
        h.cayendo.stop();
        h.disableInteractive();
    });

    scene.add.text(canvas_w / 2, canvas_h / 2, 'GAME OVER', { fontSize: '40px', fill: '#FFF' }).setOrigin(0.5);
    scene.add.text(canvas_w / 2, canvas_h / 2 + 50, 'Puntuaci√≥n: ' + puntuacion, { fontSize: '30px', fill: '#FFF' }).setOrigin(0.5);
}

function actualiza() {
    if (gameOver) return;
}
